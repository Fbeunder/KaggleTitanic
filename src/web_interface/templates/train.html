{% extends "base.html" %}

{% block title %}Train Models - Titanic Survival Predictor{% endblock %}

{% block head %}
{{ super() }}
<!-- Add Plotly.js for data visualization -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- Add error handler for Plotly loading -->
<script>
window.addEventListener('error', function(e) {
    if (e.target.tagName === 'SCRIPT' && e.target.src.includes('plotly')) {
        console.error('Error loading Plotly.js. Will attempt to use backup source.', e);
        
        // Add backup source
        const backupScript = document.createElement('script');
        backupScript.src = "https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.29.1/plotly.min.js";
        document.head.appendChild(backupScript);
        
        // Log event
        console.log('Added backup Plotly source from CDN');
    }
}, true);
</script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-body">
                <h1 class="card-title">
                    <i class="fas fa-cogs text-primary me-2"></i>Train Models
                </h1>
                <p class="lead">
                    Train various machine learning models to predict Titanic passenger survival.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-4 mb-4 mb-lg-0">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Model Selection</h4>
            </div>
            <div class="card-body">
                <form id="model-selection-form" method="post" action="{{ url_for('train') }}">
                    <div class="mb-3">
                        <label for="model-type" class="form-label">Model Type:</label>
                        <select id="model-type" name="model_type" class="form-select">
                            <option value="logistic_regression">Logistic Regression</option>
                            <option value="random_forest">Random Forest</option>
                            <option value="decision_tree">Decision Tree</option>
                            <option value="svm">Support Vector Machine</option>
                            <option value="knn">K-Nearest Neighbors</option>
                            <option value="gradient_boosting">Gradient Boosting</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="feature-engineering" class="form-label">Feature Engineering:</label>
                        <select id="feature-engineering" name="feature_engineering" class="form-select">
                            <option value="basic">Basic Features</option>
                            <option value="enhanced">Enhanced Features</option>
                            <option value="all">All Features</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cross-validation" class="form-label">Cross-Validation Folds:</label>
                        <input type="number" id="cross-validation" name="cross_validation" class="form-control" min="2" max="10" value="5">
                    </div>
                    
                    <div class="mb-3">
                        <label for="test-size" class="form-label">Test Size (%):</label>
                        <input type="range" class="form-range" id="test-size" name="test_size" min="10" max="40" value="20" step="5">
                        <div class="text-center" id="test-size-value">20%</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="hyperparameter-tuning" name="hyperparameter_tuning" value="1" checked>
                        <label class="form-check-label" for="hyperparameter-tuning">Hyperparameter Tuning</label>
                    </div>
                    
                    <button type="button" class="btn btn-primary w-100" id="btn-show-params">
                        <i class="fas fa-sliders-h me-1"></i>Configure Parameters
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Model Parameters</h4>
            </div>
            <div class="card-body">
                <!-- Logistic Regression Parameters -->
                <div id="params-logistic_regression" class="model-params">
                    <h5 class="card-subtitle mb-3">Logistic Regression Parameters</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="lr-penalty" class="form-label">Regularization:</label>
                            <select id="lr-penalty" class="form-select">
                                <option value="l2">L2 (Ridge)</option>
                                <option value="l1">L1 (Lasso)</option>
                                <option value="elasticnet">ElasticNet</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="lr-C" class="form-label">Regularization Strength (C):</label>
                            <input type="number" id="lr-C" class="form-control" min="0.1" max="10" step="0.1" value="1.0">
                        </div>
                        <div class="col-md-6">
                            <label for="lr-solver" class="form-label">Solver:</label>
                            <select id="lr-solver" class="form-select">
                                <option value="lbfgs">LBFGS</option>
                                <option value="liblinear">LibLinear</option>
                                <option value="newton-cg">Newton-CG</option>
                                <option value="sag">SAG</option>
                                <option value="saga">SAGA</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="lr-max-iter" class="form-label">Max Iterations:</label>
                            <input type="number" id="lr-max-iter" class="form-control" min="100" max="1000" step="100" value="100">
                        </div>
                    </div>
                </div>
                
                <!-- Random Forest Parameters -->
                <div id="params-random_forest" class="model-params" style="display: none;">
                    <h5 class="card-subtitle mb-3">Random Forest Parameters</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="rf-n-estimators" class="form-label">Number of Trees:</label>
                            <input type="number" id="rf-n-estimators" class="form-control" min="10" max="500" step="10" value="100">
                        </div>
                        <div class="col-md-6">
                            <label for="rf-max-depth" class="form-label">Max Depth:</label>
                            <input type="number" id="rf-max-depth" class="form-control" min="1" max="20" value="10">
                        </div>
                        <div class="col-md-6">
                            <label for="rf-min-samples-split" class="form-label">Min Samples Split:</label>
                            <input type="number" id="rf-min-samples-split" class="form-control" min="2" max="20" value="2">
                        </div>
                        <div class="col-md-6">
                            <label for="rf-min-samples-leaf" class="form-label">Min Samples Leaf:</label>
                            <input type="number" id="rf-min-samples-leaf" class="form-control" min="1" max="20" value="1">
                        </div>
                    </div>
                </div>
                
                <!-- Other model parameters would be added similarly -->
                
                <div class="mt-4">
                    <button type="button" class="btn btn-success w-100" id="btn-train-model">
                        <i class="fas fa-play me-1"></i>Train Model
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Training Progress & Results</h4>
            </div>
            <div class="card-body">
                <!-- Progress bar -->
                <div id="training-progress-container" style="display: none;">
                    <h5 class="card-subtitle mb-2">Training in Progress...</h5>
                    <div class="progress mb-3">
                        <div id="training-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="training-status">Initializing training...</p>
                </div>
                
                <!-- Results (initially hidden) -->
                <div id="training-results" style="display: none;">
                    <h5 class="card-subtitle mb-3">Training Results</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">Performance Metrics</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-striped">
                                        <tbody>
                                            <tr>
                                                <th>Accuracy:</th>
                                                <td id="result-accuracy">-</td>
                                            </tr>
                                            <tr>
                                                <th>Precision:</th>
                                                <td id="result-precision">-</td>
                                            </tr>
                                            <tr>
                                                <th>Recall:</th>
                                                <td id="result-recall">-</td>
                                            </tr>
                                            <tr>
                                                <th>F1 Score:</th>
                                                <td id="result-f1">-</td>
                                            </tr>
                                            <tr>
                                                <th>AUC-ROC:</th>
                                                <td id="result-auc">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">Confusion Matrix</h6>
                                </div>
                                <div class="card-body">
                                    <div id="confusion-matrix" style="height: 200px;">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">ROC Curve</h6>
                                </div>
                                <div class="card-body">
                                    <div id="roc-curve" style="height: 200px;">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">Feature Importance</h6>
                                </div>
                                <div class="card-body">
                                    <div id="feature-importance-chart" style="height: 200px;">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <button type="button" class="btn btn-primary me-2" id="btn-save-model">
                                <i class="fas fa-save me-1"></i>Save Model
                            </button>
                            <button type="button" class="btn btn-secondary" id="btn-compare-models">
                                <i class="fas fa-chart-line me-1"></i>Compare with Other Models
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Initial prompt -->
                <div id="training-initial" class="text-center py-5">
                    <p class="mb-0">
                        <i class="fas fa-info-circle me-1"></i>Select a model type and configure parameters, then click "Train Model" to start training.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Plotly is available
    let plotlyAvailable = (typeof Plotly !== 'undefined');
    console.log('Plotly available:', plotlyAvailable, plotlyAvailable ? Plotly.version : 'Not loaded');

    // Update test size display
    const testSizeSlider = document.getElementById('test-size');
    const testSizeValue = document.getElementById('test-size-value');
    
    testSizeSlider.addEventListener('input', function() {
        testSizeValue.textContent = this.value + '%';
    });
    
    // Show/hide model parameters based on selection
    const modelTypeSelect = document.getElementById('model-type');
    const allParamDivs = document.querySelectorAll('.model-params');
    
    modelTypeSelect.addEventListener('change', function() {
        // Hide all parameter divs
        allParamDivs.forEach(div => div.style.display = 'none');
        
        // Show the selected model's parameters
        const selectedParamDiv = document.getElementById('params-' + this.value);
        if (selectedParamDiv) {
            selectedParamDiv.style.display = 'block';
        }
    });
    
    // Train model button click
    document.getElementById('btn-train-model').addEventListener('click', function() {
        // Get form data
        const formData = new FormData(document.getElementById('model-selection-form'));
        // Add model parameters
        const modelType = document.getElementById('model-type').value;
        
        // Hide initial prompt
        document.getElementById('training-initial').style.display = 'none';
        
        // Show progress
        document.getElementById('training-progress-container').style.display = 'block';
        document.getElementById('training-results').style.display = 'none';
        
        // Simulate training progress
        let progress = 0;
        const progressBar = document.getElementById('training-progress-bar');
        const statusText = document.getElementById('training-status');
        
        const progressInterval = setInterval(function() {
            progress += 10;
            progressBar.style.width = progress + '%';
            
            if (progress === 10) {
                statusText.textContent = 'Preparing data...';
            } else if (progress === 30) {
                statusText.textContent = 'Applying feature engineering...';
            } else if (progress === 50) {
                statusText.textContent = 'Training model...';
            } else if (progress === 70) {
                statusText.textContent = 'Evaluating model...';
            } else if (progress === 90) {
                statusText.textContent = 'Finalizing results...';
            } else if (progress >= 100) {
                clearInterval(progressInterval);
                statusText.textContent = 'Training complete!';
                
                // Submit form to perform actual training
                document.getElementById('model-selection-form').submit();
            }
        }, 400);
    });
    
    // Configure Parameters button click
    document.getElementById('btn-show-params').addEventListener('click', function() {
        // Scroll to the parameters section
        const paramsSection = document.querySelector('.card-header.bg-primary.text-white h4.card-title.mb-0');
        if (paramsSection && paramsSection.textContent.includes('Model Parameters')) {
            paramsSection.scrollIntoView({ behavior: 'smooth' });
        }
    });
    
    // Save and Compare buttons
    document.getElementById('btn-save-model').addEventListener('click', function() {
        alert('Model saved successfully!');
    });
    
    document.getElementById('btn-compare-models').addEventListener('click', function() {
        window.location.href = "{{ url_for('results') }}?model=" + document.getElementById('model-type').value;
    });
    
    // Initialize visualizations if this is a result page
    const urlParams = new URLSearchParams(window.location.search);
    const selectedModel = urlParams.get('model');
    
    if (selectedModel && document.getElementById('training-results')) {
        // Show results section
        document.getElementById('training-initial').style.display = 'none';
        document.getElementById('training-progress-container').style.display = 'none';
        document.getElementById('training-results').style.display = 'block';
        
        // Fetch model details to populate results
        fetch(`/api/model-details?model=${selectedModel}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Model details data:', data);
                
                // Update performance metrics
                if (data.metrics) {
                    document.getElementById('result-accuracy').textContent = 
                        (data.metrics.accuracy * 100).toFixed(1) + '%';
                    document.getElementById('result-precision').textContent = 
                        (data.metrics.precision * 100).toFixed(1) + '%';
                    document.getElementById('result-recall').textContent = 
                        (data.metrics.recall * 100).toFixed(1) + '%';
                    document.getElementById('result-f1').textContent = 
                        (data.metrics.f1 * 100).toFixed(1) + '%';
                    document.getElementById('result-auc').textContent = 
                        data.metrics.roc_auc ? data.metrics.roc_auc.toFixed(3) : 'N/A';
                }
                
                // Render visualizations (with error handling for each)
                try {
                    renderConfusionMatrix(data.confusion_matrix, 'confusion-matrix');
                } catch (error) {
                    console.error('Error rendering confusion matrix:', error);
                    document.getElementById('confusion-matrix').innerHTML = `
                        <div class="alert alert-warning">
                            Error rendering confusion matrix. See console for details.
                        </div>`;
                }
                
                try {
                    renderRocCurve(data.roc_curve, 'roc-curve');
                } catch (error) {
                    console.error('Error rendering ROC curve:', error);
                    document.getElementById('roc-curve').innerHTML = `
                        <div class="alert alert-warning">
                            Error rendering ROC curve. See console for details.
                        </div>`;
                }
                
                try {
                    renderFeatureImportance(data.feature_importance, 'feature-importance-chart');
                } catch (error) {
                    console.error('Error rendering feature importance:', error);
                    document.getElementById('feature-importance-chart').innerHTML = `
                        <div class="alert alert-warning">
                            Error rendering feature importance. See console for details.
                        </div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching model details:', error);
                
                // Show error message in each visualization area
                document.getElementById('confusion-matrix').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Failed to load data.</strong><br>
                        ${error.message}
                    </div>`;
                
                document.getElementById('roc-curve').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Failed to load data.</strong><br>
                        ${error.message}
                    </div>`;
                
                document.getElementById('feature-importance-chart').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Failed to load data.</strong><br>
                        ${error.message}
                    </div>`;
            });
    }
    
    // Function to render confusion matrix
    function renderConfusionMatrix(confusionMatrix, elementId) {
        const element = document.getElementById(elementId);
        
        if (!confusionMatrix || !Array.isArray(confusionMatrix) || confusionMatrix.length !== 2) {
            element.innerHTML = 
                '<div class="alert alert-warning">Confusion matrix data not available</div>';
            return;
        }
        
        // Check if Plotly is available
        if (!plotlyAvailable) {
            // Fallback to table representation
            renderConfusionMatrixAsTable(confusionMatrix, elementId);
            return;
        }
        
        // Create confusion matrix visualization using Plotly
        try {
            const data = [{
                z: confusionMatrix,
                x: ['Predicted Died', 'Predicted Survived'],
                y: ['Actual Died', 'Actual Survived'],
                type: 'heatmap',
                colorscale: 'Blues',
                showscale: false,
                text: [
                    [`TN: ${confusionMatrix[0][0]}`, `FP: ${confusionMatrix[0][1]}`],
                    [`FN: ${confusionMatrix[1][0]}`, `TP: ${confusionMatrix[1][1]}`]
                ],
                hoverinfo: 'text'
            }];
            
            const layout = {
                title: 'Confusion Matrix',
                xaxis: { title: 'Predicted' },
                yaxis: { title: 'Actual' },
                annotations: [],
                margin: {
                    l: 60,
                    r: 30,
                    b: 60,
                    t: 40,
                    pad: 4
                }
            };
            
            // Add text annotations to each cell
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 2; j++) {
                    const annotationText = confusionMatrix[i][j].toString();
                    layout.annotations.push({
                        x: j,
                        y: i,
                        text: annotationText,
                        font: { color: 'white' },
                        showarrow: false
                    });
                }
            }
            
            Plotly.newPlot(elementId, data, layout, { responsive: true });
        } catch (error) {
            console.error('Error creating confusion matrix plot:', error);
            renderConfusionMatrixAsTable(confusionMatrix, elementId);
        }
    }
    
    // Function to render confusion matrix as HTML table (fallback)
    function renderConfusionMatrixAsTable(confusionMatrix, elementId) {
        const element = document.getElementById(elementId);
        
        // Create HTML table
        const tableHTML = `
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th></th>
                        <th>Predicted Died</th>
                        <th>Predicted Survived</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Actual Died</th>
                        <td class="bg-info text-white">${confusionMatrix[0][0]}</td>
                        <td>${confusionMatrix[0][1]}</td>
                    </tr>
                    <tr>
                        <th>Actual Survived</th>
                        <td>${confusionMatrix[1][0]}</td>
                        <td class="bg-info text-white">${confusionMatrix[1][1]}</td>
                    </tr>
                </tbody>
            </table>
            <p class="text-muted small">Fallback table mode: Plotly visualization not available</p>
        `;
        
        element.innerHTML = tableHTML;
    }
    
    // Function to render ROC curve
    function renderRocCurve(rocData, elementId) {
        const element = document.getElementById(elementId);
        
        if (!rocData || !rocData.fpr || !rocData.tpr) {
            element.innerHTML = 
                '<div class="alert alert-warning">ROC curve data not available</div>';
            return;
        }
        
        // Check if Plotly is available
        if (!plotlyAvailable) {
            // Fallback to simplified display
            renderRocCurveAsSummary(rocData, elementId);
            return;
        }
        
        // Create ROC curve visualization using Plotly
        try {
            const data = [
                {
                    x: rocData.fpr,
                    y: rocData.tpr,
                    type: 'scatter',
                    mode: 'lines',
                    name: `ROC Curve (AUC = ${rocData.auc.toFixed(3)})`,
                    line: { color: 'blue', width: 2 }
                },
                {
                    x: [0, 1],
                    y: [0, 1],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Random',
                    line: { color: 'grey', width: 2, dash: 'dash' }
                }
            ];
            
            const layout = {
                title: 'ROC Curve',
                xaxis: { title: 'False Positive Rate' },
                yaxis: { title: 'True Positive Rate' },
                legend: { x: 0.6, y: 0.2 },
                showlegend: true,
                margin: {
                    l: 60,
                    r: 30,
                    b: 60,
                    t: 40,
                    pad: 4
                }
            };
            
            Plotly.newPlot(elementId, data, layout, { responsive: true });
        } catch (error) {
            console.error('Error creating ROC curve plot:', error);
            renderRocCurveAsSummary(rocData, elementId);
        }
    }
    
    // Function to render ROC curve as simplified summary (fallback)
    function renderRocCurveAsSummary(rocData, elementId) {
        const element = document.getElementById(elementId);
        
        // Create a simple card with AUC value
        const auc = rocData.auc.toFixed(3);
        const cardHTML = `
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">ROC Curve Summary</h5>
                    <p class="card-text">Area Under Curve (AUC): <strong>${auc}</strong></p>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" role="progressbar" 
                            style="width: ${auc * 100}%" 
                            aria-valuenow="${auc * 100}" aria-valuemin="0" aria-valuemax="100">
                            ${(auc * 100).toFixed(1)}%
                        </div>
                    </div>
                    <p class="text-muted small">Fallback mode: Plotly visualization not available</p>
                </div>
            </div>
        `;
        
        element.innerHTML = cardHTML;
    }
    
    // Function to render feature importance
    function renderFeatureImportance(featureImportance, elementId) {
        const element = document.getElementById(elementId);
        
        if (!featureImportance || !Array.isArray(featureImportance) || featureImportance.length === 0) {
            element.innerHTML = 
                '<div class="alert alert-warning">Feature importance data not available</div>';
            return;
        }
        
        // Extract features and importance values
        const features = featureImportance.map(item => item[0]);
        const importanceValues = featureImportance.map(item => item[1]);
        
        // Sort in descending order of importance
        const indices = Array.from(Array(features.length).keys())
            .sort((a, b) => importanceValues[b] - importanceValues[a]);
        
        const sortedFeatures = indices.map(i => features[i]);
        const sortedImportance = indices.map(i => importanceValues[i]);
        
        // Only show top 10 features
        const topFeatures = sortedFeatures.slice(0, 10);
        const topImportance = sortedImportance.slice(0, 10);
        
        // Check if Plotly is available
        if (!plotlyAvailable) {
            // Fallback to horizontal bar representation with HTML/CSS
            renderFeatureImportanceAsTable(topFeatures, topImportance, elementId);
            return;
        }
        
        // Create feature importance visualization using Plotly
        try {
            const data = [{
                y: topFeatures,
                x: topImportance,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: 'rgba(58, 123, 213, 0.8)',
                    line: {
                        color: 'rgba(58, 123, 213, 1.0)',
                        width: 1
                    }
                }
            }];
            
            const layout = {
                title: 'Top 10 Feature Importance',
                xaxis: { title: 'Importance' },
                yaxis: { title: 'Feature', automargin: true },
                margin: {
                    l: 150,
                    r: 30,
                    b: 60,
                    t: 40,
                    pad: 4
                }
            };
            
            Plotly.newPlot(elementId, data, layout, { responsive: true });
        } catch (error) {
            console.error('Error creating feature importance plot:', error);
            renderFeatureImportanceAsTable(topFeatures, topImportance, elementId);
        }
    }
    
    // Function to render feature importance as HTML table with bars (fallback)
    function renderFeatureImportanceAsTable(features, importance, elementId) {
        const element = document.getElementById(elementId);
        
        // Create HTML table with CSS progress bars
        let tableHTML = `
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Importance</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // Add rows
        features.forEach((feature, index) => {
            const value = importance[index];
            const percentage = (value * 100).toFixed(1);
            
            tableHTML += `
                <tr>
                    <td>${feature}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                    style="width: ${percentage}%" 
                                    aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span>${value.toFixed(3)}</span>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableHTML += `
                </tbody>
            </table>
            <p class="text-muted small">Fallback table mode: Plotly visualization not available</p>
        `;
        
        element.innerHTML = tableHTML;
    }
});
</script>
{% endblock %}
